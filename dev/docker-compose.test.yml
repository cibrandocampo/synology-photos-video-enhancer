services:
  video-enhancer-test:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: synology-photos-video-enhancer-test
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
      # Test configuration - minimal required env vars
      - MEDIA_APP_PATH=/test/media
      - DATABASE_APP_PATH=/test/data/test.db
      - HW_TRANSCODING=False
      - EXECUTION_THREADS=1
      - STARTUP_DELAY=0
      - EXECUTION_INTERVAL=60
      - VIDEO_CODEC=h264
      - VIDEO_BITRATE=1024
      - VIDEO_RESOLUTION=480p
      - AUDIO_CODEC=aac
      - AUDIO_BITRATE=64
      - AUDIO_CHANNELS=1
      - LOGGER_LEVEL=WARNING
    volumes:
      # Mount source code for tests
      - ../src:/app
      - ../tests:/app/tests
      # Mount dev directory to access requirements-dev.txt
      - ../dev:/app/dev:ro
      # Test data directory (read-only)
      - ../tests/data:/test/data:ro
      # Test media directory (read-only)
      - ../tests/media:/test/media:ro
    # No need for hardware acceleration in tests
    # Override entrypoint to install test dependencies and run pytest
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Installing test dependencies..."
        pip install -q -r dev/requirements-dev.txt
        echo "Running tests..."
        python -m pytest tests/ -v --cov=. --cov-report=term-missing
